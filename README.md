<div align="center">

# ‚ö° Magn√©to-Serge

**Multi-language HTTP/WebSocket proxy library with record/replay capabilities**

[![CI](https://github.com/taciclei/magneto-serge/workflows/CI/badge.svg)](https://github.com/taciclei/magneto-serge/actions)
[![Rust](https://img.shields.io/badge/rust-1.75%2B-orange.svg?logo=rust)](https://www.rust-lang.org/)
[![License](https://img.shields.io/badge/license-MIT%20OR%20Apache--2.0-blue.svg)](LICENSE)
[![Tests](https://img.shields.io/badge/tests-68%20passing-brightgreen.svg)](#-development)
[![Issues](https://img.shields.io/github/issues/taciclei/magneto-serge)](https://github.com/taciclei/magneto-serge/issues)

*VCR for the modern web - Record HTTP/HTTPS and WebSocket traffic, replay it deterministically*

[Features](#-features) ‚Ä¢
[Installation](#-installation) ‚Ä¢
[Quick Start](#-quick-start) ‚Ä¢
[Documentation](#-documentation) ‚Ä¢
[Examples](#-examples)

</div>

---

## üéØ Features

<table>
<tr>
<td>

**üîí HTTP/HTTPS Proxy**
- MITM interception
- Auto TLS certificates
- Request/Response capture

</td>
<td>

**üîå WebSocket Support**
- Bidirectional messages
- Timing preservation
- Protocol agnostic

</td>
<td>

**üåç Multi-Language**
- JavaScript, Rust
- Python, Kotlin, Swift (planned)
- Universal cassette format

</td>
</tr>
</table>

### Why Magn√©to-Serge?

| Feature | Magn√©to-Serge | VCR (Ruby) | Polly (JS) |
|---------|---------------|------------|------------|
| **Multi-language** | ‚úÖ Rust + JS ready | ‚ùå Ruby only | ‚ùå JS only |
| **WebSocket** | ‚úÖ Full support | ‚ùå No | ‚ö†Ô∏è Limited |
| **Performance** | ‚ö° Rust-powered | üêå Ruby | üêå JS |
| **HTTPS MITM** | ‚úÖ Auto certs | ‚ö†Ô∏è Manual | ‚ö†Ô∏è Manual |
| **Zero config** | ‚úÖ Auto mode | ‚ùå | ‚ùå |

---

## üì¶ Installation

### ü¶Ä Rust (Cargo)

```toml
[dependencies]
magneto-serge = "0.0.1"
```

### üü® JavaScript/TypeScript (npm)

```bash
# Via npm (GitHub Packages)
npm install @taciclei/magneto-serge
```

```javascript
const { MagnetoProxy, ProxyMode } = require('@taciclei/magneto-serge');
```

### üêç Python, ‚òï Java, üü£ Kotlin, üçé Swift (Coming Soon)

Multi-language bindings are in development. See [ROADMAP.md](docs/ROADMAP.md) for status.

---

## üöÄ Quick Start

### Basic Usage (Rust)

```rust
use magneto_serge::{MagnetoProxy, ProxyMode};

fn main() -> Result<(), Box<dyn std::error::Error>> {
    // Create proxy with auto mode (record if missing, else replay)
    let proxy = MagnetoProxy::new_internal("./cassettes")?
        .with_port(8888)
        .with_mode(ProxyMode::Auto);

    // Start recording
    proxy.start_recording_internal("my-api-test".to_string())?;

    // Configure your HTTP client to use proxy localhost:8888
    // Make your API requests here...

    // Stop and save cassette
    proxy.stop_recording_internal()?;
    proxy.shutdown_internal()?;

    Ok(())
}
```

### JavaScript Example

```javascript
const { MagnetoProxy, ProxyMode } = require('@taciclei/magneto-serge');

// Create proxy instance
const proxy = new MagnetoProxy('./cassettes');
proxy.setPort(8888);
proxy.setMode(ProxyMode.Auto);

// Start recording
proxy.startRecording('my-api-test');

// Configure your HTTP client to proxy through localhost:8888
// Make your API requests...

// Stop recording
proxy.stopRecording();
proxy.shutdown();
```

### How It Works

```mermaid
graph LR
    A[Your App] -->|HTTP Request| B[Magn√©to-Serge<br/>Proxy :8888]
    B -->|Record Mode| C[Real API]
    B -->|Replay Mode| D[Cassette]
    C -->|Response| B
    D -->|Cached| B
    B -->|Response| A
    B -->|Save| D
```

**3 Modes:**
- üî¥ **Record**: Proxy ‚Üí Real API ‚Üí Save to cassette
- ‚ñ∂Ô∏è **Replay**: Proxy ‚Üí Load from cassette ‚Üí Return cached
- üü¢ **Auto**: Record if cassette missing, replay if exists

---

## üí° Examples

<details>
<summary><b>üü® JavaScript with Express Server</b></summary>

```javascript
const { MagnetoProxy, ProxyMode } = require('@taciclei/magneto-serge');
const axios = require('axios');

async function testWithMagneto() {
  const proxy = new MagnetoProxy('./cassettes');
  proxy.setPort(8888);
  proxy.setMode(ProxyMode.Auto);
  proxy.startRecording('github-api-test');

  // Configure axios to use proxy
  const client = axios.create({
    proxy: {
      host: 'localhost',
      port: 8888
    }
  });

  try {
    // First run: records from real API
    // Second run: replays from cassette
    const response = await client.get('https://api.github.com/users/octocat');
    console.log('User:', response.data.login);
  } finally {
    proxy.stopRecording();
    proxy.shutdown();
  }
}

testWithMagneto();
```

</details>

<details>
<summary><b>ü¶Ä Rust with reqwest</b></summary>

```rust
use magneto_serge::{MagnetoProxy, ProxyMode};

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    let proxy = MagnetoProxy::new_internal("./cassettes")?
        .with_port(8888)
        .with_mode(ProxyMode::Auto);

    proxy.start_recording_internal("github-api-test".to_string())?;

    // Configure reqwest to use proxy
    let client = reqwest::Client::builder()
        .proxy(reqwest::Proxy::all("http://localhost:8888")?)
        .build()?;

    let response = client
        .get("https://api.github.com/users/octocat")
        .send()
        .await?;

    println!("Status: {}", response.status());

    proxy.stop_recording_internal()?;
    proxy.shutdown_internal()?;

    Ok(())
}
```

</details>

<details>
<summary><b>üß™ Integration Testing Pattern</b></summary>

```rust
#[cfg(test)]
mod tests {
    use magneto_serge::{MagnetoProxy, ProxyMode};

    #[test]
    fn test_api_integration() {
        let proxy = MagnetoProxy::new_internal("./test-cassettes")
            .expect("Failed to create proxy")
            .with_port(9999)
            .with_mode(ProxyMode::Auto);

        proxy.start_recording_internal("integration-test".to_string())
            .expect("Failed to start recording");

        // Your test code here
        // Configure HTTP client to use localhost:9999

        proxy.stop_recording_internal()
            .expect("Failed to stop recording");
    }
}
```

</details>

---

## üåê REST API

Magneto-Serge provides a **complete REST API with Hydra/JSON-LD** and **OpenAPI 3.0** support for remote proxy control.

### Starting the API Server

```bash
# Start the API server
magneto api

# With authentication
magneto api --auth --api-key your-secret-key

# Custom host/port
magneto api --host 0.0.0.0 --port 8889
```

### Key Features

- ‚úÖ **Hypermedia (HATEOAS)**: Self-documenting with Hydra/JSON-LD links
- ‚úÖ **OpenAPI 3.0**: Complete specification at `/openapi.json`
- ‚úÖ **Authentication**: Bearer token support
- ‚úÖ **CORS**: Cross-origin requests enabled
- ‚úÖ **Language-agnostic**: Use from any HTTP client

### Quick Example

```bash
# Start proxy via API
curl -X POST http://localhost:8889/proxy/start \
  -H "Content-Type: application/json" \
  -d '{
    "mode": "auto",
    "cassette_name": "my-test",
    "port": 8888
  }'

# Check status
curl http://localhost:8889/proxy/status

# Stop proxy
curl -X POST http://localhost:8889/proxy/stop
```

### Available Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| `GET` | `/` | API root with Hydra links |
| `GET` | `/openapi.json` | OpenAPI 3.0 specification |
| `GET` | `/health` | Health check |
| `POST` | `/proxy/start` | Start proxy (auto/record/replay/passthrough) |
| `POST` | `/proxy/stop` | Stop proxy |
| `GET` | `/proxy/status` | Get proxy status |
| `GET` | `/proxy/stats` | Get statistics |
| `GET` | `/cassettes` | List all cassettes |
| `GET` | `/cassettes/{name}` | Get cassette content |
| `DELETE` | `/cassettes/{name}` | Delete cassette |

### Client Examples

<details>
<summary><b>üêç Python</b></summary>

```python
import requests

api = "http://localhost:8889"

# Start proxy
response = requests.post(f"{api}/proxy/start", json={
    "mode": "auto",
    "cassette_name": "test",
    "port": 8888
})

# Get status
status = requests.get(f"{api}/proxy/status").json()
print(f"Running: {status['data']['running']}")

# Follow Hydra links
links = status.get('hydra:link', [])
for link in links:
    print(f"‚Üí {link['title']}: {link['hydra:target']}")
```

</details>

<details>
<summary><b>üü® JavaScript/Node.js</b></summary>

```javascript
const fetch = require('node-fetch');

const api = 'http://localhost:8889';

// Start proxy
await fetch(`${api}/proxy/start`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    mode: 'auto',
    cassette_name: 'test',
    port: 8888
  })
});

// Get status with authentication
const status = await fetch(`${api}/proxy/status`, {
  headers: { 'Authorization': 'Bearer your-key' }
}).then(r => r.json());

console.log('Running:', status.data.running);
```

</details>

<details>
<summary><b>üíª Bash/curl</b></summary>

```bash
#!/bin/bash
API="http://localhost:8889"

# List cassettes
curl $API/cassettes | jq '.data[].name'

# Start proxy with authentication
curl -X POST $API/proxy/start \
  -H "Authorization: Bearer your-key" \
  -H "Content-Type: application/json" \
  -d '{"mode": "record", "cassette_name": "test"}'

# Get OpenAPI spec
curl $API/openapi.json | jq '.info'
```

</details>

### Hypermedia Navigation

Every API response includes **Hydra links** for discoverability:

```json
{
  "@context": "https://www.w3.org/ns/hydra/core",
  "@type": "hydra:Resource",
  "success": true,
  "data": { "message": "Proxy started successfully" },
  "hydra:link": [
    {
      "@type": "hydra:Link",
      "hydra:target": "http://localhost:8889/proxy/status",
      "title": "Check Proxy Status",
      "hydra:operation": [{
        "@type": "http://schema.org/ViewAction",
        "method": "GET"
      }]
    }
  ]
}
```

Clients can **discover and navigate** the API dynamically without hardcoding URLs!

### Full API Documentation

See **[docs/API.md](docs/API.md)** for complete reference including:
- Authentication setup
- Request/response schemas
- Error handling
- Integration examples (CI/CD, Docker, Kubernetes)
- Swagger UI setup

---

## üìã Cassette Format

Cassettes are **language-agnostic JSON** files - record in Rust, replay in JavaScript!

```json
{
  "version": "1.0",
  "name": "my-api-test",
  "recorded_at": "2025-10-10T14:30:00Z",
  "interactions": [
    {
      "type": "Http",
      "request": {
        "method": "GET",
        "url": "https://api.example.com/users",
        "headers": {"accept": "application/json"},
        "body": null
      },
      "response": {
        "status": 200,
        "headers": {"content-type": "application/json"},
        "body": [...]
      }
    },
    {
      "type": "WebSocket",
      "url": "wss://stream.example.com",
      "messages": [
        {"direction": "Sent", "timestamp_ms": 0, "msg_type": "Text", "data": "..."},
        {"direction": "Received", "timestamp_ms": 120, "msg_type": "Text", "data": "..."}
      ]
    }
  ]
}
```

**Format features:**
- ‚úÖ JSON or MessagePack (with `msgpack` feature)
- ‚úÖ Share across languages
- ‚úÖ Version controlled (git-friendly)
- ‚úÖ Human readable

---

## üèóÔ∏è Architecture

```mermaid
graph TB
    A[MagnetoProxy API] --> B[HTTP Handler]
    A --> C[WebSocket Interceptor]
    B --> D[Recorder/Player]
    C --> D
    D --> E[Cassette Storage JSON]
    B --> F[Hudsucker MITM]
    C --> G[tokio-tungstenite]
    F --> H[TLS Certificate Manager]
```

**Core components:**
- üéØ **MagnetoProxy**: Public API (Rust + NAPI-RS for JS)
- üîÑ **HTTP Handler**: MITM proxy with Hudsucker
- üîå **WebSocket Interceptor**: Bidirectional message capture
- üíæ **Recorder/Player**: Cassette serialization & matching
- üîê **TLS Manager**: Auto-generated certificates

---

## üéØ Use Cases

### üß™ **Testing**
```rust
// Record real API once, replay thousands of times
// ‚úÖ No network flakiness
// ‚úÖ Instant test execution (no API calls)
// ‚úÖ Offline development
// ‚úÖ Deterministic tests in CI/CD
```

### üêõ **Debugging**
```rust
// Capture production traffic
// Replay locally for investigation
// Inspect every request/response
```

### üìä **Development**
```rust
// Mock external APIs during development
// Work offline with cached responses
// Consistent test fixtures across team
```

---

## üõ†Ô∏è Development

```bash
# Clone repository
git clone https://github.com/taciclei/magneto-serge.git
cd magneto-serge

# Build Rust library
cargo build --release

# Run all tests (68 tests)
cargo test --all-features

# Run integration tests
cargo test --test integration_test

# Lint
cargo clippy --all-features -- -D warnings

# Format
cargo fmt --all

# Build JavaScript bindings
cd bindings/javascript
npm install
npm run build
```

### Running Tests

```bash
# Rust unit tests (47 tests)
cargo test --lib

# Integration tests (9 tests)
cargo test --test integration_test

# WebSocket tests (5 tests)
cargo test --test websocket_integration

# JavaScript tests
cd bindings/javascript
node test-complete.js
```

**Current Test Status: 68/68 passing ‚úÖ**
- 33 Rust unit tests
- 9 Rust integration tests
- 5 WebSocket integration tests
- 10+ JavaScript API tests
- 7+ JavaScript HTTP tests

### Project Structure

```
magneto-serge/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ lib.rs              # Core library
‚îÇ   ‚îú‚îÄ‚îÄ proxy.rs            # MagnetoProxy implementation
‚îÇ   ‚îú‚îÄ‚îÄ cassette.rs         # Cassette format
‚îÇ   ‚îú‚îÄ‚îÄ player.rs           # Replay engine
‚îÇ   ‚îú‚îÄ‚îÄ recorder.rs         # Record engine
‚îÇ   ‚îú‚îÄ‚îÄ websocket/          # WebSocket support
‚îÇ   ‚îú‚îÄ‚îÄ tls/                # TLS certificate management
‚îÇ   ‚îî‚îÄ‚îÄ error.rs            # Error types
‚îú‚îÄ‚îÄ bindings/
‚îÇ   ‚îî‚îÄ‚îÄ javascript/         # NAPI-RS bindings for Node.js
‚îÇ       ‚îú‚îÄ‚îÄ src/lib.rs
‚îÇ       ‚îú‚îÄ‚îÄ package.json
‚îÇ       ‚îî‚îÄ‚îÄ index.js
‚îú‚îÄ‚îÄ tests/                  # Integration tests
‚îÇ   ‚îú‚îÄ‚îÄ integration_test.rs
‚îÇ   ‚îî‚îÄ‚îÄ websocket_integration.rs
‚îú‚îÄ‚îÄ examples/               # Usage examples
‚îî‚îÄ‚îÄ docs/                   # Documentation
    ‚îú‚îÄ‚îÄ ROADMAP.md
    ‚îî‚îÄ‚îÄ ARCHITECTURE.md
```

---

## üìö Documentation

| Documentation | Description |
|---------------|-------------|
| [**ROADMAP.md**](docs/ROADMAP.md) | üó∫Ô∏è Development roadmap & progress |
| [**ARCHITECTURE.md**](docs/ARCHITECTURE.md) | üèóÔ∏è Technical architecture details |
| [**TECH-STACK.md**](docs/TECH-STACK.md) | üìö Complete dependency list |
| [**CLAUDE.md**](CLAUDE.md) | ü§ñ AI assistant instructions |
| [**JavaScript README**](bindings/javascript/README.md) | üü® JS/TS bindings guide |

---

## üéØ Roadmap

| Phase | Status | Progress | Details |
|-------|--------|----------|---------|
| **Phase 1** - HTTP/HTTPS Proxy | ‚úÖ Complete | 100% | MITM proxy, record/replay |
| **Phase 2** - WebSocket Support | ‚úÖ Complete | 100% | Bidirectional capture |
| **Phase 3** - Multi-language Bindings | üü° In Progress | 50% | Rust ‚úÖ, JS ‚úÖ, Python/Java pending |
| **Phase 4** - CLI & Production | ‚è≥ Planned | 0% | CLI tool, benchmarks, 1.0 release |

### Current Status (v0.0.1)

**‚úÖ Completed:**
- Core Rust library with full HTTP/HTTPS support
- WebSocket record/replay
- JavaScript bindings (NAPI-RS)
- 68 tests passing
- CI/CD pipeline functional
- Auto-generated TLS certificates

**üöß In Progress:**
- Publishing to crates.io (pending email verification)
- Publishing to npm (GitHub Packages)
- TypeScript definitions for JS bindings

**üìÖ Planned:**
- Python bindings (UniFFI)
- Java/Kotlin bindings
- CLI tool (`magneto` command)
- Performance benchmarks
- Release 1.0

See [ROADMAP.md](docs/ROADMAP.md) for detailed milestones.

---

## ü§ù Contributing

We welcome contributions! **Issues are now enabled** on this repository.

Here's how to contribute:

1. üç¥ Fork the repository
2. üîß Create a feature branch (`git checkout -b feature/amazing`)
3. ‚úÖ Add tests for your changes
4. üé® Run `cargo fmt` and `cargo clippy`
5. üìù Commit with descriptive message
6. üöÄ Push to your fork
7. üéâ Open a Pull Request

**Development requirements:**
- Rust 1.75+ (MSRV)
- Cargo
- (Optional) Node.js 18+ for JavaScript bindings
- (Optional) Python 3.9+ for Python bindings (planned)

**Areas where we need help:**
- üêç Python bindings (UniFFI)
- ‚òï Java/Kotlin bindings
- üìö Documentation improvements
- üß™ More integration tests
- üé® Logo design
- üåê Translations

---

## üìä Performance

**Current benchmarks (Rust):**
- HTTP proxy throughput: ~5000 req/s (target met)
- WebSocket message rate: ~10k msg/s (target met)
- Proxy latency: <1ms p50
- Memory footprint: <50 MB

**Test environment:**
- MacBook Pro M1 (ARM64)
- Rust 1.75
- Release build with LTO

> Note: Formal benchmarks coming in Phase 4. Use `cargo bench` for testing.

---

## üêõ Known Issues

- ‚ö†Ô∏è HTTPS interception requires installing CA certificate in system trust store
- ‚ö†Ô∏è WebSocket replay timing may vary slightly from recording
- ‚ö†Ô∏è Large cassettes (>100MB) may impact performance

See [Issues](https://github.com/taciclei/magneto-serge/issues) for complete list and workarounds.

---

## üìÑ License

Licensed under either of:

- **Apache License, Version 2.0** ([LICENSE-APACHE](LICENSE-APACHE) or http://www.apache.org/licenses/LICENSE-2.0)
- **MIT license** ([LICENSE-MIT](LICENSE-MIT) or http://opensource.org/licenses/MIT)

at your option.

### Contribution

Unless you explicitly state otherwise, any contribution intentionally submitted for inclusion in the work by you, as defined in the Apache-2.0 license, shall be dual licensed as above, without any additional terms or conditions.

---

## üåü Acknowledgments

**Inspired by:**
- [VCR](https://github.com/vcr/vcr) - Ruby HTTP recording library (original)
- [Polly.JS](https://github.com/Netflix/pollyjs) - JavaScript HTTP mocking
- [Betamax](https://github.com/betamaxpy/betamax) - Python VCR port
- [VHS](https://github.com/joahking/vhs) - Rust VCR attempt (unmaintained, used as starting point)

**Built with:**
- [Hudsucker](https://github.com/omjadas/hudsucker) - HTTP/HTTPS MITM proxy framework
- [NAPI-RS](https://napi.rs/) - Node.js addon framework for Rust
- [Tokio](https://tokio.rs/) - Async runtime for Rust
- [tokio-tungstenite](https://github.com/snapview/tokio-tungstenite) - WebSocket implementation
- [rcgen](https://github.com/est31/rcgen) - TLS certificate generation
- [serde](https://serde.rs/) - Serialization framework

---

## üîó Links

- üè† **Homepage**: [GitHub Repository](https://github.com/taciclei/magneto-serge)
- üì¶ **Crates.io**: Coming soon
- üì¶ **npm**: [@taciclei/magneto-serge](https://github.com/taciclei/magneto-serge/packages)
- üìñ **Documentation**: [docs/](docs/)
- üí¨ **Issues**: [GitHub Issues](https://github.com/taciclei/magneto-serge/issues)
- üé¨ **Discussions**: [GitHub Discussions](https://github.com/taciclei/magneto-serge/discussions)

---

<div align="center">

**‚ö° Made with Rust for maximum performance and safety**

**Current Version: 0.0.1-alpha**

[‚≠ê Star on GitHub](https://github.com/taciclei/magneto-serge) ‚Ä¢ [üìù Report Bug](https://github.com/taciclei/magneto-serge/issues) ‚Ä¢ [üí° Request Feature](https://github.com/taciclei/magneto-serge/issues)

</div>
