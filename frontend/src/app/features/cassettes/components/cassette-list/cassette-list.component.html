<mat-card>
  <mat-card-header>
    <mat-card-title>Cassettes Magnéto-Serge</mat-card-title>
    <mat-card-subtitle>
      <ng-container *ngIf="paginationInfo$ | async as pagination">
        Affichage {{ pagination.startIndex }} - {{ pagination.endIndex }} sur {{ pagination.totalItems }}
      </ng-container>
    </mat-card-subtitle>
    <button mat-icon-button (click)="reload()" [disabled]="(loading$ | async) ?? false">
      <mat-icon>refresh</mat-icon>
    </button>
  </mat-card-header>

  <mat-card-content>
    <!-- Search and Filter Bar -->
    <div class="search-filter-bar">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Rechercher</mat-label>
        <input
          matInput
          type="text"
          [(ngModel)]="searchQuery"
          (ngModelChange)="onSearchChange($event)"
          placeholder="Rechercher par nom..."
        >
        <mat-icon matPrefix>search</mat-icon>
        <button
          *ngIf="searchQuery"
          mat-icon-button
          matSuffix
          (click)="searchQuery = ''; onSearchChange('')"
          matTooltip="Effacer"
        >
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <mat-form-field appearance="outline" class="sort-field">
        <mat-label>Trier par</mat-label>
        <mat-select
          [(ngModel)]="selectedSortBy"
          (ngModelChange)="onSortByChange($event)"
        >
          <mat-option *ngFor="let option of sortOptions" [value]="option.value">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="sort-order-field">
        <mat-label>Ordre</mat-label>
        <mat-select
          [(ngModel)]="selectedSortOrder"
          (ngModelChange)="onSortOrderChange($event)"
        >
          <mat-option *ngFor="let option of sortOrderOptions" [value]="option.value">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <button
        mat-raised-button
        color="warn"
        (click)="clearFilters()"
        *ngIf="searchQuery || selectedSortBy"
        matTooltip="Réinitialiser les filtres"
      >
        <mat-icon>filter_list_off</mat-icon>
        Effacer
      </button>
    </div>
    <!-- Loading Spinner -->
    <div *ngIf="loading$ | async" class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Chargement des cassettes...</p>
    </div>

    <!-- Error Message -->
    <div *ngIf="error$ | async as error" class="error-container">
      <mat-icon color="warn">error</mat-icon>
      <p>{{ error }}</p>
      <button mat-raised-button color="primary" (click)="reload()">
        Réessayer
      </button>
    </div>

    <!-- Table -->
    <div *ngIf="!(loading$ | async) && !(error$ | async)" class="table-container">
      <table mat-table [dataSource]="(cassettes$ | async) ?? []" class="cassette-table">

        <!-- Colonne Nom -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Nom</th>
          <td mat-cell *matCellDef="let cassette">
            <strong>{{ cassette.name }}</strong>
          </td>
        </ng-container>

        <!-- Colonne Version -->
        <ng-container matColumnDef="version">
          <th mat-header-cell *matHeaderCellDef>Version</th>
          <td mat-cell *matCellDef="let cassette">{{ cassette.version }}</td>
        </ng-container>

        <!-- Colonne Date d'enregistrement -->
        <ng-container matColumnDef="recordedAt">
          <th mat-header-cell *matHeaderCellDef>Enregistrée le</th>
          <td mat-cell *matCellDef="let cassette">{{ formatDate(cassette.recordedAt) }}</td>
        </ng-container>

        <!-- Colonne Nombre d'interactions -->
        <ng-container matColumnDef="interactionCount">
          <th mat-header-cell *matHeaderCellDef>Interactions</th>
          <td mat-cell *matCellDef="let cassette" class="text-center">
            <mat-icon class="interaction-icon">sync_alt</mat-icon>
            {{ cassette.interactionCount }}
          </td>
        </ng-container>

        <!-- Colonne Taille -->
        <ng-container matColumnDef="sizeBytes">
          <th mat-header-cell *matHeaderCellDef>Taille</th>
          <td mat-cell *matCellDef="let cassette">{{ formatSize(cassette.sizeBytes) }}</td>
        </ng-container>

        <!-- Colonne Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let cassette">
            <button
              mat-icon-button
              color="primary"
              (click)="viewDetails(cassette)"
              matTooltip="Voir les détails"
            >
              <mat-icon>visibility</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns;"
          class="cassette-row"
        ></tr>

        <!-- No Data Row -->
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" [attr.colspan]="displayedColumns.length">
            <div class="no-data">
              <mat-icon>inbox</mat-icon>
              <p>Aucune cassette disponible</p>
            </div>
          </td>
        </tr>
      </table>
    </div>

    <!-- Pagination Hydra -->
    <div *ngIf="!(loading$ | async) && (paginationInfo$ | async) as pagination" class="pagination-container">
      <div class="pagination-info">
        Page {{ pagination.page }} sur {{ pagination.totalPages }}
      </div>
      <div class="pagination-controls">
        <button
          mat-icon-button
          (click)="firstPage()"
          [disabled]="!pagination.hasPrevious"
          matTooltip="Première page"
        >
          <mat-icon>first_page</mat-icon>
        </button>
        <button
          mat-icon-button
          (click)="previousPage()"
          [disabled]="!pagination.hasPrevious"
          matTooltip="Page précédente"
        >
          <mat-icon>chevron_left</mat-icon>
        </button>
        <button
          mat-icon-button
          (click)="nextPage()"
          [disabled]="!pagination.hasNext"
          matTooltip="Page suivante"
        >
          <mat-icon>chevron_right</mat-icon>
        </button>
        <button
          mat-icon-button
          (click)="lastPage()"
          [disabled]="!pagination.hasNext"
          matTooltip="Dernière page"
        >
          <mat-icon>last_page</mat-icon>
        </button>
      </div>
    </div>
  </mat-card-content>
</mat-card>
